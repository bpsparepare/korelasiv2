
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:cached_network_image/cached_network_image.dart'; 
import '../models/order_history.dart';

import '../services/api_service.dart';
import 'dart:developer' as developer; 

class HistoryScreen extends StatefulWidget {
  const HistoryScreen({super.key});

  @override
  State<HistoryScreen> createState() => _HistoryScreenState();
}

class _HistoryScreenState extends State<HistoryScreen> {
  List<OrderHistory> _orderHistory = [];
  bool _isLoading = true;
  String _errorMessage = '';
  String? _currentUserId; 

  @override
  void initState() {
    super.initState();
    _loadUserIdAndFetchHistory();
  }

  
  Future<void> _loadUserIdAndFetchHistory() async {
    final SharedPreferences prefs = await SharedPreferences.getInstance();
    _currentUserId = prefs.getString('userId');
    if (!mounted) return; 
    if (_currentUserId != null) {
      _fetchOrderHistory(_currentUserId!);
    } else {
      setState(() {
        _isLoading = false;
        _errorMessage = 'ID Pelanggan tidak ditemukan. Silakan login kembali.';
      });
    }
  }

  
  Future<void> _fetchOrderHistory(String customerId) async {
    setState(() {
      _isLoading = true;
      _errorMessage = '';
    });
    try {
      developer.log('Fetching order history for customer ID: $customerId');
      final fetchedHistory = await ApiService().getOrderHistory(customerId);
      if (!mounted) return; 

      
      fetchedHistory.sort((a, b) {
        
        
        
        try {
          
          return DateTime.parse(
            b.orderDate,
          ).compareTo(DateTime.parse(a.orderDate));
        } catch (e) {
          
          return b.orderDate.compareTo(a.orderDate);
        }
      });

      setState(() {
        _orderHistory = fetchedHistory;
        _isLoading = false;
      });
      developer.log('Order history fetched: ${_orderHistory.length} orders');
      if (_orderHistory.isEmpty) {
        _errorMessage = 'Tidak ada riwayat pesanan.';
      }
    } catch (e) {
      developer.log('Error fetching order history: $e');
      if (!mounted) return; 
      setState(() {
        _errorMessage = 'Gagal memuat riwayat pesanan: $e';
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final Color primaryColor = Color.fromARGB(255, 255, 158, 68);

    return Scaffold(
      appBar: AppBar(
        title: const Text(
          'Riwayat Pembelian',
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: Colors.white,
            fontSize: 18,
          ),
        ),
        centerTitle: true,
        
        
        
        
        
        
        
        
        backgroundColor: primaryColor,
        automaticallyImplyLeading: false,
        
        
        
        
        
        
        
      ),
      body:
          _isLoading
              ? const Center(child: CircularProgressIndicator())
              : _errorMessage.isNotEmpty
              ? Center(
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Text(
                    _errorMessage,
                    textAlign: TextAlign.center,
                    style: const TextStyle(fontSize: 16, color: Colors.red),
                  ),
                ),
              )
              : _orderHistory.isEmpty
              ? Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.history, size: 100, color: Colors.grey[400]),
                    const SizedBox(height: 20),
                    const Text(
                      'Belum ada riwayat pembelian.',
                      style: TextStyle(fontSize: 18, color: Colors.grey),
                    ),
                  ],
                ),
              )
              : ListView.builder(
                padding: const EdgeInsets.all(16.0),
                itemCount: _orderHistory.length,
                itemBuilder: (context, index) {
                  final order = _orderHistory[index];
                  return Card(
                    margin: const EdgeInsets.symmetric(vertical: 10.0),
                    elevation: 3,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(15),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          
                          Text(
                            'Tanggal: ${order.orderDate}',
                            style: const TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 14,
                            ),
                          ),
                          const SizedBox(height: 0),
                          Text(
                            'Total Pesanan: Rp ${order.totalOrderPrice.toStringAsFixed(0)}',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 12,
                              color: primaryColor,
                            ),
                          ),
                          const Divider(height: 5),
                          const Text(
                            'Item:',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 12,
                            ),
                          ),
                          
                          ...order.items.map((item) {
                            return Padding(
                              padding: const EdgeInsets.symmetric(
                                vertical: 4.0,
                                horizontal: 8.0,
                              ),
                              child: Row(
                                children: [
                                  
                                  Container(
                                    width: 45, 
                                    height: 45, 
                                    decoration: BoxDecoration(
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                    child: CachedNetworkImage(
                                      imageUrl: item.gambarUrl,
                                      fit: BoxFit.cover,
                                      placeholder:
                                          (context, url) =>
                                              const CircularProgressIndicator(), 
                                      errorWidget: (context, url, error) {
                                        developer.log(
                                          'Error loading image for ${item.productName} (${item.gambarUrl}): $error',
                                        );
                                        return const Icon(
                                          Icons.broken_image,
                                          size: 40,
                                          color: Colors.grey,
                                        ); 
                                      },
                                    ),
                                  ),
                                  const SizedBox(width: 12),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        
                                        Text(
                                          '${item.productName} (${item.jumlah} ${item.satuan})',
                                          style: const TextStyle(
                                            fontSize: 12,
                                            fontWeight: FontWeight.w600,
                                          ),
                                        ),
                                        Text(
                                          'Harga: Rp ${item.harga.toStringAsFixed(0)}', 
                                          style: const TextStyle(
                                            fontSize: 11,
                                            color: Colors.black54,
                                          ),
                                        ),
                                        Text(
                                          'Subtotal: Rp ${item.subtotal.toStringAsFixed(0)}',
                                          style: const TextStyle(
                                            fontSize: 11,
                                            color: Colors.black87,
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                            );
                          }),
                        ],
                      ),
                    ),
                  );
                },
              ),
    );
  }
}

import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:cached_network_image/cached_network_image.dart'; 
import '../models/order_history.dart';

import '../services/api_service.dart';
import 'dart:developer' as developer; 

class HistoryScreen extends StatefulWidget {
  const HistoryScreen({super.key});

  @override
  State<HistoryScreen> createState() => _HistoryScreenState();
}

class _HistoryScreenState extends State<HistoryScreen> {
  List<OrderHistory> _orderHistory = [];
  bool _isLoading = true;
  String _errorMessage = '';
  String? _currentUserId; 

  @override
  void initState() {
    super.initState();
    _loadUserIdAndFetchHistory();
  }

  
  Future<void> _loadUserIdAndFetchHistory() async {
    final SharedPreferences prefs = await SharedPreferences.getInstance();
    _currentUserId = prefs.getString('userId');
    if (!mounted) return; 
    if (_currentUserId != null) {
      _fetchOrderHistory(_currentUserId!);
    } else {
      setState(() {
        _isLoading = false;
        _errorMessage = 'ID Pelanggan tidak ditemukan. Silakan login kembali.';
      });
    }
  }

  
  Future<void> _fetchOrderHistory(String customerId) async {
    setState(() {
      _isLoading = true;
      _errorMessage = '';
    });
    try {
      developer.log('Fetching order history for customer ID: $customerId');
      final fetchedHistory = await ApiService().getOrderHistory(customerId);
      if (!mounted) return; 

      
      fetchedHistory.sort((a, b) {
        
        
        
        try {
          
          return DateTime.parse(
            b.orderDate,
          ).compareTo(DateTime.parse(a.orderDate));
        } catch (e) {
          
          return b.orderDate.compareTo(a.orderDate);
        }
      });

      setState(() {
        _orderHistory = fetchedHistory;
        _isLoading = false;
      });
      developer.log('Order history fetched: ${_orderHistory.length} orders');
      if (_orderHistory.isEmpty) {
        _errorMessage = 'Tidak ada riwayat pesanan.';
      }
    } catch (e) {
      developer.log('Error fetching order history: $e');
      if (!mounted) return; 
      setState(() {
        _errorMessage = 'Gagal memuat riwayat pesanan: $e';
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final Color primaryColor = Color.fromARGB(255, 255, 158, 68);

    return Scaffold(
      appBar: AppBar(
        title: const Text(
          'Riwayat Pembelian',
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: Colors.white,
            fontSize: 18,
          ),
        ),
        centerTitle: true,
        
        
        
        
        
        
        
        
        backgroundColor: primaryColor,
        automaticallyImplyLeading: false,
        
        
        
        
        
        
        
      ),
      body:
          _isLoading
              ? const Center(child: CircularProgressIndicator())
              : _errorMessage.isNotEmpty
              ? Center(
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Text(
                    _errorMessage,
                    textAlign: TextAlign.center,
                    style: const TextStyle(fontSize: 16, color: Colors.red),
                  ),
                ),
              )
              : _orderHistory.isEmpty
              ? Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.history, size: 100, color: Colors.grey[400]),
                    const SizedBox(height: 20),
                    const Text(
                      'Belum ada riwayat pembelian.',
                      style: TextStyle(fontSize: 18, color: Colors.grey),
                    ),
                  ],
                ),
              )
              : ListView.builder(
                padding: const EdgeInsets.all(16.0),
                itemCount: _orderHistory.length,
                itemBuilder: (context, index) {
                  final order = _orderHistory[index];
                  return Card(
                    margin: const EdgeInsets.symmetric(vertical: 10.0),
                    elevation: 3,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(15),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          
                          Text(
                            'Tanggal: ${order.orderDate}',
                            style: const TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 14,
                            ),
                          ),
                          const SizedBox(height: 0),
                          Text(
                            'Total Pesanan: Rp ${order.totalOrderPrice.toStringAsFixed(0)}',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 12,
                              color: primaryColor,
                            ),
                          ),
                          const Divider(height: 5),
                          const Text(
                            'Item:',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 12,
                            ),
                          ),
                          
                          ...order.items.map((item) {
                            return Padding(
                              padding: const EdgeInsets.symmetric(
                                vertical: 4.0,
                                horizontal: 8.0,
                              ),
                              child: Row(
                                children: [
                                  
                                  Container(
                                    width: 45, 
                                    height: 45, 
                                    decoration: BoxDecoration(
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                    child: CachedNetworkImage(
                                      imageUrl: item.gambarUrl,
                                      fit: BoxFit.cover,
                                      placeholder:
                                          (context, url) =>
                                              const CircularProgressIndicator(), 
                                      errorWidget: (context, url, error) {
                                        developer.log(
                                          'Error loading image for ${item.productName} (${item.gambarUrl}): $error',
                                        );
                                        return const Icon(
                                          Icons.broken_image,
                                          size: 40,
                                          color: Colors.grey,
                                        ); 
                                      },
                                    ),
                                  ),
                                  const SizedBox(width: 12),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        
                                        Text(
                                          '${item.productName} (${item.jumlah} ${item.satuan})',
                                          style: const TextStyle(
                                            fontSize: 12,
                                            fontWeight: FontWeight.w600,
                                          ),
                                        ),
                                        Text(
                                          'Harga: Rp ${item.harga.toStringAsFixed(0)}', 
                                          style: const TextStyle(
                                            fontSize: 11,
                                            color: Colors.black54,
                                          ),
                                        ),
                                        Text(
                                          'Subtotal: Rp ${item.subtotal.toStringAsFixed(0)}',
                                          style: const TextStyle(
                                            fontSize: 11,
                                            color: Colors.black87,
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                            );
                          }),
                        ],
                      ),
                    ),
                  );
                },
              ),
    );
  }
}
